{{ config(
    materialized = 'table',
    description = 'Retail calendar based on client-provided week start dates',
    schema = 'staging'  
) }}

-- Step 1: Create a CTE with the client's provided week start dates
WITH client_week_starts AS (
  SELECT * FROM (
        -- ========================================
    -- 2021-2022 ADDITION (Oct 2025)
    -- Comment out this section if it causes issues
    -- ========================================
    
    -- 2021 Week Starts
    SELECT 1 as week_num, 2021 as retail_year, DATE '2021-01-03' as week_start_date UNION ALL
    SELECT 2, 2021, DATE '2021-01-10' UNION ALL
    SELECT 3, 2021, DATE '2021-01-17' UNION ALL
    SELECT 4, 2021, DATE '2021-01-24' UNION ALL
    SELECT 5, 2021, DATE '2021-01-31' UNION ALL
    SELECT 6, 2021, DATE '2021-02-07' UNION ALL
    SELECT 7, 2021, DATE '2021-02-14' UNION ALL
    SELECT 8, 2021, DATE '2021-02-21' UNION ALL
    SELECT 9, 2021, DATE '2021-02-28' UNION ALL
    SELECT 10, 2021, DATE '2021-03-07' UNION ALL
    SELECT 11, 2021, DATE '2021-03-14' UNION ALL
    SELECT 12, 2021, DATE '2021-03-21' UNION ALL
    SELECT 13, 2021, DATE '2021-03-28' UNION ALL
    SELECT 14, 2021, DATE '2021-04-04' UNION ALL
    SELECT 15, 2021, DATE '2021-04-11' UNION ALL
    SELECT 16, 2021, DATE '2021-04-18' UNION ALL
    SELECT 17, 2021, DATE '2021-04-25' UNION ALL
    SELECT 18, 2021, DATE '2021-05-02' UNION ALL
    SELECT 19, 2021, DATE '2021-05-09' UNION ALL
    SELECT 20, 2021, DATE '2021-05-16' UNION ALL
    SELECT 21, 2021, DATE '2021-05-23' UNION ALL
    SELECT 22, 2021, DATE '2021-05-30' UNION ALL
    SELECT 23, 2021, DATE '2021-06-06' UNION ALL
    SELECT 24, 2021, DATE '2021-06-13' UNION ALL
    SELECT 25, 2021, DATE '2021-06-20' UNION ALL
    SELECT 26, 2021, DATE '2021-06-27' UNION ALL
    SELECT 27, 2021, DATE '2021-07-04' UNION ALL
    SELECT 28, 2021, DATE '2021-07-11' UNION ALL
    SELECT 29, 2021, DATE '2021-07-18' UNION ALL
    SELECT 30, 2021, DATE '2021-07-25' UNION ALL
    SELECT 31, 2021, DATE '2021-08-01' UNION ALL
    SELECT 32, 2021, DATE '2021-08-08' UNION ALL
    SELECT 33, 2021, DATE '2021-08-15' UNION ALL
    SELECT 34, 2021, DATE '2021-08-22' UNION ALL
    SELECT 35, 2021, DATE '2021-08-29' UNION ALL
    SELECT 36, 2021, DATE '2021-09-05' UNION ALL
    SELECT 37, 2021, DATE '2021-09-12' UNION ALL
    SELECT 38, 2021, DATE '2021-09-19' UNION ALL
    SELECT 39, 2021, DATE '2021-09-26' UNION ALL
    SELECT 40, 2021, DATE '2021-10-03' UNION ALL
    SELECT 41, 2021, DATE '2021-10-10' UNION ALL
    SELECT 42, 2021, DATE '2021-10-17' UNION ALL
    SELECT 43, 2021, DATE '2021-10-24' UNION ALL
    SELECT 44, 2021, DATE '2021-10-31' UNION ALL
    SELECT 45, 2021, DATE '2021-11-07' UNION ALL
    SELECT 46, 2021, DATE '2021-11-14' UNION ALL
    SELECT 47, 2021, DATE '2021-11-21' UNION ALL
    SELECT 48, 2021, DATE '2021-11-28' UNION ALL
    SELECT 49, 2021, DATE '2021-12-05' UNION ALL
    SELECT 50, 2021, DATE '2021-12-12' UNION ALL
    SELECT 51, 2021, DATE '2021-12-19' UNION ALL
    SELECT 52, 2021, DATE '2021-12-26' UNION ALL

    -- 2022 Week Starts
    SELECT 1, 2022, DATE '2022-01-02' UNION ALL
    SELECT 2, 2022, DATE '2022-01-09' UNION ALL
    SELECT 3, 2022, DATE '2022-01-16' UNION ALL
    SELECT 4, 2022, DATE '2022-01-23' UNION ALL
    SELECT 5, 2022, DATE '2022-01-30' UNION ALL
    SELECT 6, 2022, DATE '2022-02-06' UNION ALL
    SELECT 7, 2022, DATE '2022-02-13' UNION ALL
    SELECT 8, 2022, DATE '2022-02-20' UNION ALL
    SELECT 9, 2022, DATE '2022-02-27' UNION ALL
    SELECT 10, 2022, DATE '2022-03-06' UNION ALL
    SELECT 11, 2022, DATE '2022-03-13' UNION ALL
    SELECT 12, 2022, DATE '2022-03-20' UNION ALL
    SELECT 13, 2022, DATE '2022-03-27' UNION ALL
    SELECT 14, 2022, DATE '2022-04-03' UNION ALL
    SELECT 15, 2022, DATE '2022-04-10' UNION ALL
    SELECT 16, 2022, DATE '2022-04-17' UNION ALL
    SELECT 17, 2022, DATE '2022-04-24' UNION ALL
    SELECT 18, 2022, DATE '2022-05-01' UNION ALL
    SELECT 19, 2022, DATE '2022-05-08' UNION ALL
    SELECT 20, 2022, DATE '2022-05-15' UNION ALL
    SELECT 21, 2022, DATE '2022-05-22' UNION ALL
    SELECT 22, 2022, DATE '2022-05-29' UNION ALL
    SELECT 23, 2022, DATE '2022-06-05' UNION ALL
    SELECT 24, 2022, DATE '2022-06-12' UNION ALL
    SELECT 25, 2022, DATE '2022-06-19' UNION ALL
    SELECT 26, 2022, DATE '2022-06-26' UNION ALL
    SELECT 27, 2022, DATE '2022-07-03' UNION ALL
    SELECT 28, 2022, DATE '2022-07-10' UNION ALL
    SELECT 29, 2022, DATE '2022-07-17' UNION ALL
    SELECT 30, 2022, DATE '2022-07-24' UNION ALL
    SELECT 31, 2022, DATE '2022-07-31' UNION ALL
    SELECT 32, 2022, DATE '2022-08-07' UNION ALL
    SELECT 33, 2022, DATE '2022-08-14' UNION ALL
    SELECT 34, 2022, DATE '2022-08-21' UNION ALL
    SELECT 35, 2022, DATE '2022-08-28' UNION ALL
    SELECT 36, 2022, DATE '2022-09-04' UNION ALL
    SELECT 37, 2022, DATE '2022-09-11' UNION ALL
    SELECT 38, 2022, DATE '2022-09-18' UNION ALL
    SELECT 39, 2022, DATE '2022-09-25' UNION ALL
    SELECT 40, 2022, DATE '2022-10-02' UNION ALL
    SELECT 41, 2022, DATE '2022-10-09' UNION ALL
    SELECT 42, 2022, DATE '2022-10-16' UNION ALL
    SELECT 43, 2022, DATE '2022-10-23' UNION ALL
    SELECT 44, 2022, DATE '2022-10-30' UNION ALL
    SELECT 45, 2022, DATE '2022-11-06' UNION ALL
    SELECT 46, 2022, DATE '2022-11-13' UNION ALL
    SELECT 47, 2022, DATE '2022-11-20' UNION ALL
    SELECT 48, 2022, DATE '2022-11-27' UNION ALL
    SELECT 49, 2022, DATE '2022-12-04' UNION ALL
    SELECT 50, 2022, DATE '2022-12-11' UNION ALL
    SELECT 51, 2022, DATE '2022-12-18' UNION ALL
    SELECT 52, 2022, DATE '2022-12-25' UNION ALL
    
    -- ========================================
    -- END 2021-2022 ADDITION
    -- ========================================
    -- 2023 Week Starts
    SELECT 1 as week_num, 2023 as retail_year, DATE '2023-01-01' as week_start_date UNION ALL
    SELECT 2, 2023, DATE '2023-01-08' UNION ALL
    SELECT 3, 2023, DATE '2023-01-15' UNION ALL
    SELECT 4, 2023, DATE '2023-01-22' UNION ALL
    SELECT 5, 2023, DATE '2023-01-29' UNION ALL
    SELECT 6, 2023, DATE '2023-02-05' UNION ALL
    SELECT 7, 2023, DATE '2023-02-12' UNION ALL
    SELECT 8, 2023, DATE '2023-02-19' UNION ALL
    SELECT 9, 2023, DATE '2023-02-26' UNION ALL
    SELECT 10, 2023, DATE '2023-03-05' UNION ALL
    SELECT 11, 2023, DATE '2023-03-12' UNION ALL
    SELECT 12, 2023, DATE '2023-03-19' UNION ALL
    SELECT 13, 2023, DATE '2023-03-26' UNION ALL
    SELECT 14, 2023, DATE '2023-04-02' UNION ALL
    SELECT 15, 2023, DATE '2023-04-09' UNION ALL
    SELECT 16, 2023, DATE '2023-04-16' UNION ALL
    SELECT 17, 2023, DATE '2023-04-23' UNION ALL
    SELECT 18, 2023, DATE '2023-04-30' UNION ALL
    SELECT 19, 2023, DATE '2023-05-07' UNION ALL
    SELECT 20, 2023, DATE '2023-05-14' UNION ALL
    SELECT 21, 2023, DATE '2023-05-21' UNION ALL
    SELECT 22, 2023, DATE '2023-05-28' UNION ALL
    SELECT 23, 2023, DATE '2023-06-04' UNION ALL
    SELECT 24, 2023, DATE '2023-06-11' UNION ALL
    SELECT 25, 2023, DATE '2023-06-18' UNION ALL
    SELECT 26, 2023, DATE '2023-06-25' UNION ALL
    SELECT 27, 2023, DATE '2023-07-02' UNION ALL
    SELECT 28, 2023, DATE '2023-07-09' UNION ALL
    SELECT 29, 2023, DATE '2023-07-16' UNION ALL
    SELECT 30, 2023, DATE '2023-07-23' UNION ALL
    SELECT 31, 2023, DATE '2023-07-30' UNION ALL
    SELECT 32, 2023, DATE '2023-08-06' UNION ALL
    SELECT 33, 2023, DATE '2023-08-13' UNION ALL
    SELECT 34, 2023, DATE '2023-08-20' UNION ALL
    SELECT 35, 2023, DATE '2023-08-27' UNION ALL
    SELECT 36, 2023, DATE '2023-09-03' UNION ALL
    SELECT 37, 2023, DATE '2023-09-10' UNION ALL
    SELECT 38, 2023, DATE '2023-09-17' UNION ALL
    SELECT 39, 2023, DATE '2023-09-24' UNION ALL
    SELECT 40, 2023, DATE '2023-10-01' UNION ALL
    SELECT 41, 2023, DATE '2023-10-08' UNION ALL
    SELECT 42, 2023, DATE '2023-10-15' UNION ALL
    SELECT 43, 2023, DATE '2023-10-22' UNION ALL
    SELECT 44, 2023, DATE '2023-10-29' UNION ALL
    SELECT 45, 2023, DATE '2023-11-05' UNION ALL
    SELECT 46, 2023, DATE '2023-11-12' UNION ALL
    SELECT 47, 2023, DATE '2023-11-19' UNION ALL
    SELECT 48, 2023, DATE '2023-11-26' UNION ALL
    SELECT 49, 2023, DATE '2023-12-03' UNION ALL
    SELECT 50, 2023, DATE '2023-12-10' UNION ALL
    SELECT 51, 2023, DATE '2023-12-17' UNION ALL
    SELECT 52, 2023, DATE '2023-12-24' UNION ALL
    
    -- 2024 Week Starts
    SELECT 1, 2024, DATE '2023-12-31' UNION ALL
    SELECT 2, 2024, DATE '2024-01-07' UNION ALL
    SELECT 3, 2024, DATE '2024-01-14' UNION ALL
    SELECT 4, 2024, DATE '2024-01-21' UNION ALL
    SELECT 5, 2024, DATE '2024-01-28' UNION ALL
    SELECT 6, 2024, DATE '2024-02-04' UNION ALL
    SELECT 7, 2024, DATE '2024-02-11' UNION ALL
    SELECT 8, 2024, DATE '2024-02-18' UNION ALL
    SELECT 9, 2024, DATE '2024-02-25' UNION ALL
    SELECT 10, 2024, DATE '2024-03-03' UNION ALL
    SELECT 11, 2024, DATE '2024-03-10' UNION ALL
    SELECT 12, 2024, DATE '2024-03-17' UNION ALL
    SELECT 13, 2024, DATE '2024-03-24' UNION ALL
    SELECT 14, 2024, DATE '2024-03-31' UNION ALL
    SELECT 15, 2024, DATE '2024-04-07' UNION ALL
    SELECT 16, 2024, DATE '2024-04-14' UNION ALL
    SELECT 17, 2024, DATE '2024-04-21' UNION ALL
    SELECT 18, 2024, DATE '2024-04-28' UNION ALL
    SELECT 19, 2024, DATE '2024-05-05' UNION ALL
    SELECT 20, 2024, DATE '2024-05-12' UNION ALL
    SELECT 21, 2024, DATE '2024-05-19' UNION ALL
    SELECT 22, 2024, DATE '2024-05-26' UNION ALL
    SELECT 23, 2024, DATE '2024-06-02' UNION ALL
    SELECT 24, 2024, DATE '2024-06-09' UNION ALL
    SELECT 25, 2024, DATE '2024-06-16' UNION ALL
    SELECT 26, 2024, DATE '2024-06-23' UNION ALL
    SELECT 27, 2024, DATE '2024-06-30' UNION ALL
    SELECT 28, 2024, DATE '2024-07-07' UNION ALL
    SELECT 29, 2024, DATE '2024-07-14' UNION ALL
    SELECT 30, 2024, DATE '2024-07-21' UNION ALL
    SELECT 31, 2024, DATE '2024-07-28' UNION ALL
    SELECT 32, 2024, DATE '2024-08-04' UNION ALL
    SELECT 33, 2024, DATE '2024-08-11' UNION ALL
    SELECT 34, 2024, DATE '2024-08-18' UNION ALL
    SELECT 35, 2024, DATE '2024-08-25' UNION ALL
    SELECT 36, 2024, DATE '2024-09-01' UNION ALL
    SELECT 37, 2024, DATE '2024-09-08' UNION ALL
    SELECT 38, 2024, DATE '2024-09-15' UNION ALL
    SELECT 39, 2024, DATE '2024-09-22' UNION ALL
    SELECT 40, 2024, DATE '2024-09-29' UNION ALL
    SELECT 41, 2024, DATE '2024-10-06' UNION ALL
    SELECT 42, 2024, DATE '2024-10-13' UNION ALL
    SELECT 43, 2024, DATE '2024-10-20' UNION ALL
    SELECT 44, 2024, DATE '2024-10-27' UNION ALL
    SELECT 45, 2024, DATE '2024-11-03' UNION ALL
    SELECT 46, 2024, DATE '2024-11-10' UNION ALL
    SELECT 47, 2024, DATE '2024-11-17' UNION ALL
    SELECT 48, 2024, DATE '2024-11-24' UNION ALL
    SELECT 49, 2024, DATE '2024-12-01' UNION ALL
    SELECT 50, 2024, DATE '2024-12-08' UNION ALL
    SELECT 51, 2024, DATE '2024-12-15' UNION ALL
    SELECT 52, 2024, DATE '2024-12-22' UNION ALL
    
    -- 2025 Week Starts
    SELECT 1, 2025, DATE '2024-12-29' UNION ALL
    SELECT 2, 2025, DATE '2025-01-05' UNION ALL
    SELECT 3, 2025, DATE '2025-01-12' UNION ALL
    SELECT 4, 2025, DATE '2025-01-19' UNION ALL
    SELECT 5, 2025, DATE '2025-01-26' UNION ALL
    SELECT 6, 2025, DATE '2025-02-02' UNION ALL
    SELECT 7, 2025, DATE '2025-02-09' UNION ALL
    SELECT 8, 2025, DATE '2025-02-16' UNION ALL
    SELECT 9, 2025, DATE '2025-02-23' UNION ALL
    SELECT 10, 2025, DATE '2025-03-02' UNION ALL
    SELECT 11, 2025, DATE '2025-03-09' UNION ALL
    SELECT 12, 2025, DATE '2025-03-16' UNION ALL
    SELECT 13, 2025, DATE '2025-03-23' UNION ALL
    SELECT 14, 2025, DATE '2025-03-30' UNION ALL
    SELECT 15, 2025, DATE '2025-04-06' UNION ALL
    SELECT 16, 2025, DATE '2025-04-13' UNION ALL
    SELECT 17, 2025, DATE '2025-04-20' UNION ALL
    SELECT 18, 2025, DATE '2025-04-27' UNION ALL
    SELECT 19, 2025, DATE '2025-05-04' UNION ALL
    SELECT 20, 2025, DATE '2025-05-11' UNION ALL
    SELECT 21, 2025, DATE '2025-05-18' UNION ALL
    SELECT 22, 2025, DATE '2025-05-25' UNION ALL
    SELECT 23, 2025, DATE '2025-06-01' UNION ALL
    SELECT 24, 2025, DATE '2025-06-08' UNION ALL
    SELECT 25, 2025, DATE '2025-06-15' UNION ALL
    SELECT 26, 2025, DATE '2025-06-22' UNION ALL
    SELECT 27, 2025, DATE '2025-06-29' UNION ALL
    SELECT 28, 2025, DATE '2025-07-06' UNION ALL
    SELECT 29, 2025, DATE '2025-07-13' UNION ALL
    SELECT 30, 2025, DATE '2025-07-20' UNION ALL
    SELECT 31, 2025, DATE '2025-07-27' UNION ALL
    SELECT 32, 2025, DATE '2025-08-03' UNION ALL
    SELECT 33, 2025, DATE '2025-08-10' UNION ALL
    SELECT 34, 2025, DATE '2025-08-17' UNION ALL
    SELECT 35, 2025, DATE '2025-08-24' UNION ALL
    SELECT 36, 2025, DATE '2025-08-31' UNION ALL
    SELECT 37, 2025, DATE '2025-09-07' UNION ALL
    SELECT 38, 2025, DATE '2025-09-14' UNION ALL
    SELECT 39, 2025, DATE '2025-09-21' UNION ALL
    SELECT 40, 2025, DATE '2025-09-28' UNION ALL
    SELECT 41, 2025, DATE '2025-10-05' UNION ALL
    SELECT 42, 2025, DATE '2025-10-12' UNION ALL
    SELECT 43, 2025, DATE '2025-10-19' UNION ALL
    SELECT 44, 2025, DATE '2025-10-26' UNION ALL
    SELECT 45, 2025, DATE '2025-11-02' UNION ALL
    SELECT 46, 2025, DATE '2025-11-09' UNION ALL
    SELECT 47, 2025, DATE '2025-11-16' UNION ALL
    SELECT 48, 2025, DATE '2025-11-23' UNION ALL
    SELECT 49, 2025, DATE '2025-11-30' UNION ALL
    SELECT 50, 2025, DATE '2025-12-07' UNION ALL
    SELECT 51, 2025, DATE '2025-12-14' UNION ALL
    SELECT 52, 2025, DATE '2025-12-21' UNION ALL

    -- 2026 Week Starts
    SELECT 1, 2026, DATE '2025-12-28' UNION ALL
    SELECT 2, 2026, DATE '2026-01-04' UNION ALL
    SELECT 3, 2026, DATE '2026-01-11' UNION ALL
    SELECT 4, 2026, DATE '2026-01-18' UNION ALL
    SELECT 5, 2026, DATE '2026-01-25' UNION ALL
    SELECT 6, 2026, DATE '2026-02-01' UNION ALL
    SELECT 7, 2026, DATE '2026-02-08' UNION ALL
    SELECT 8, 2026, DATE '2026-02-15' UNION ALL
    SELECT 9, 2026, DATE '2026-02-22' UNION ALL
    SELECT 10, 2026, DATE '2026-03-01' UNION ALL
    SELECT 11, 2026, DATE '2026-03-08' UNION ALL
    SELECT 12, 2026, DATE '2026-03-15' UNION ALL
    SELECT 13, 2026, DATE '2026-03-22' UNION ALL
    SELECT 14, 2026, DATE '2026-03-29' UNION ALL
    SELECT 15, 2026, DATE '2026-04-05' UNION ALL
    SELECT 16, 2026, DATE '2026-04-12' UNION ALL
    SELECT 17, 2026, DATE '2026-04-19' UNION ALL
    SELECT 18, 2026, DATE '2026-04-26' UNION ALL
    SELECT 19, 2026, DATE '2026-05-03' UNION ALL
    SELECT 20, 2026, DATE '2026-05-10' UNION ALL
    SELECT 21, 2026, DATE '2026-05-17' UNION ALL
    SELECT 22, 2026, DATE '2026-05-24' UNION ALL
    SELECT 23, 2026, DATE '2026-05-31' UNION ALL
    SELECT 24, 2026, DATE '2026-06-07' UNION ALL
    SELECT 25, 2026, DATE '2026-06-14' UNION ALL
    SELECT 26, 2026, DATE '2026-06-21' UNION ALL
    SELECT 27, 2026, DATE '2026-06-28' UNION ALL
    SELECT 28, 2026, DATE '2026-07-05' UNION ALL
    SELECT 29, 2026, DATE '2026-07-12' UNION ALL
    SELECT 30, 2026, DATE '2026-07-19' UNION ALL
    SELECT 31, 2026, DATE '2026-07-26' UNION ALL
    SELECT 32, 2026, DATE '2026-08-02' UNION ALL
    SELECT 33, 2026, DATE '2026-08-09' UNION ALL
    SELECT 34, 2026, DATE '2026-08-16' UNION ALL
    SELECT 35, 2026, DATE '2026-08-23' UNION ALL
    SELECT 36, 2026, DATE '2026-08-30' UNION ALL
    SELECT 37, 2026, DATE '2026-09-06' UNION ALL
    SELECT 38, 2026, DATE '2026-09-13' UNION ALL
    SELECT 39, 2026, DATE '2026-09-20' UNION ALL
    SELECT 40, 2026, DATE '2026-09-27' UNION ALL
    SELECT 41, 2026, DATE '2026-10-04' UNION ALL
    SELECT 42, 2026, DATE '2026-10-11' UNION ALL
    SELECT 43, 2026, DATE '2026-10-18' UNION ALL
    SELECT 44, 2026, DATE '2026-10-25' UNION ALL
    SELECT 45, 2026, DATE '2026-11-01' UNION ALL
    SELECT 46, 2026, DATE '2026-11-08' UNION ALL
    SELECT 47, 2026, DATE '2026-11-15' UNION ALL
    SELECT 48, 2026, DATE '2026-11-22' UNION ALL
    SELECT 49, 2026, DATE '2026-11-29' UNION ALL
    SELECT 50, 2026, DATE '2026-12-06' UNION ALL
    SELECT 51, 2026, DATE '2026-12-13' UNION ALL
    SELECT 52, 2026, DATE '2026-12-20'
  )
),

-- Step 2: Add week end dates
week_spans AS (
  SELECT
    retail_year,
    week_num AS retail_week,
    week_start_date,
    DATE_ADD(week_start_date, INTERVAL 6 DAY) AS week_end_date,
    -- Find the next week start to determine year boundaries
    LEAD(week_start_date) OVER (ORDER BY week_start_date) AS next_week_start
  FROM client_week_starts
),

-- Step 3: Expand to individual days
day_level AS (
  SELECT
    ws.retail_year,
    ws.retail_week,
    day_date AS calendar_date,
    ws.week_start_date AS retail_week_start_date,
    ws.week_end_date AS retail_week_end_date
  FROM week_spans ws
  CROSS JOIN UNNEST(GENERATE_DATE_ARRAY(ws.week_start_date, ws.week_end_date)) AS day_date
),

-- Step 4: Add month mapping based on 4-4-5 pattern
months_mapped AS (
  SELECT
    calendar_date,
    retail_year,
    retail_week,
    retail_week_start_date,
    retail_week_end_date,
    FORMAT_DATE('%A', calendar_date) AS day_name,
    EXTRACT(DAYOFWEEK FROM calendar_date) AS day_of_week,  -- Sun=1 â€¦ Sat=7
    -- 4-4-5 month mapping
    CASE
      WHEN retail_week BETWEEN  1 AND  4 THEN  1  -- 4 weeks
      WHEN retail_week BETWEEN  5 AND  8 THEN  2  -- 4 weeks
      WHEN retail_week BETWEEN  9 AND 13 THEN  3  -- 5 weeks (Q1 complete)
      WHEN retail_week BETWEEN 14 AND 17 THEN  4  -- 4 weeks
      WHEN retail_week BETWEEN 18 AND 21 THEN  5  -- 4 weeks
      WHEN retail_week BETWEEN 22 AND 26 THEN  6  -- 5 weeks (Q2 complete)
      WHEN retail_week BETWEEN 27 AND 30 THEN  7  -- 4 weeks
      WHEN retail_week BETWEEN 31 AND 34 THEN  8  -- 4 weeks
      WHEN retail_week BETWEEN 35 AND 39 THEN  9  -- 5 weeks (Q3 complete)
      WHEN retail_week BETWEEN 40 AND 43 THEN 10  -- 4 weeks
      WHEN retail_week BETWEEN 44 AND 47 THEN 11  -- 4 weeks
      WHEN retail_week BETWEEN 48 AND 52 THEN 12  -- 5 weeks (Q4 complete)
      ELSE 12   -- Handle any other cases
    END AS retail_month
  FROM day_level
)

-- Step 5: Final output with all needed fields
SELECT
  calendar_date,
  day_name,
  day_of_week,
  retail_year,
  retail_week,
  retail_week_start_date,
  retail_week_end_date,
  retail_month,
  CEIL(retail_month / 3) AS retail_quarter,
  
  -- Add string versions for better Looker Studio compatibility
  CAST(retail_year AS STRING) AS retail_year_str,
  CAST(retail_week AS STRING) AS retail_week_str,
  CAST(retail_month AS STRING) AS retail_month_str,
  CAST(CEIL(retail_month / 3) AS STRING) AS retail_quarter_str,
  
  -- Add formatted display labels
  FORMAT('%04d-M%02d', retail_year, retail_month) AS retail_month_name,
  FORMAT('%04d-Wk%02d', retail_year, retail_week) AS retail_week_label,
  
  -- Add composite identifiers for filtering
  CONCAT(CAST(retail_year AS STRING), '-', CAST(retail_week AS STRING)) AS retail_year_week_id,
  CONCAT(CAST(retail_year AS STRING), '-', CAST(retail_month AS STRING)) AS retail_year_month_id
FROM months_mapped
ORDER BY calendar_date