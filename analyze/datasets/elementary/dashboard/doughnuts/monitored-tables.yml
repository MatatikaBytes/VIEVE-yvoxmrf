# This file is managed by the 'app-elementary' file bundle and updated automatically when `meltano upgrade` is run.
# To prevent any manual changes from being overwritten, remove the file bundle from `meltano.yml` or disable automatic updates:
#     meltano config --plugin-type=files app-elementary set _update analyze/datasets/elementary/dashboard/doughnuts/monitored-tables.yml false

version: datasets/v0.2
title: Monitored Tables
source: Test Results
description: "#dashboard"
metadata: |-
  {
      "label": "doughnut", 
      "related_table": {
        "columns": [
        ], 
        "aggregates": [
            {"name": "monitored", "label": "Monitored", "description": "Monitored"},
            {"name": "unmonitored", "label": "Unmonitored", "description": "Unmonitored"}
        ]
      },
    "palette": [[30, 255, 30],[166, 166, 166]]
  }
visualisation: |-
  {
      "chartjs-chart": {
        "chartType": "doughnut"
      }
  }
query: |-
  WITH all_dbt_models AS (
    SELECT UNIQUE_ID FROM `matatika_test_results.dbt_models`
    WHERE UNIQUE_ID LIKE '%my_meltano_project%'
    UNION DISTINCT
    SELECT UNIQUE_ID FROM `matatika_test_results.dbt_sources`
    WHERE UNIQUE_ID LIKE '%my_meltano_project%'
  ),
  latest_invocation AS (
    SELECT invocation_id
    FROM `matatika_test_results.elementary_test_results`
    ORDER BY created_at DESC
    LIMIT 1
  ),
  monitored_models AS (
    SELECT DISTINCT model_unique_id
    FROM `matatika_test_results.elementary_test_results`
    WHERE invocation_id = (SELECT invocation_id FROM latest_invocation)
  )
  SELECT
    COUNT(DISTINCT m.model_unique_id) AS monitored,
    COUNT(DISTINCT a.unique_id) - COUNT(DISTINCT m.model_unique_id) AS unmonitored
  FROM all_dbt_models a
  LEFT JOIN monitored_models m
    ON a.unique_id = m.model_unique_id
